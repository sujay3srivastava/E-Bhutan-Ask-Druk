upstream app {
    server 127.0.0.1:8000;
    keepalive 256;
}

# Main server configuration for Ask Druk
server {
    listen 80;
    client_max_body_size 100M;
    
    # Health check location that doesn't proxy
    location /nginx-health {
        access_log off;
        return 200 "Ask Druk Nginx healthy\n";
    }

    # Handle SSL termination at the load balancer level
    set $fixed_proto $http_x_forwarded_proto;
    if ($fixed_proto = '') {
        set $fixed_proto $scheme;
    }

    # Additional header for troubleshooting
    add_header X-Service-Info "Ask Druk - Bhutan AI Assistant" always;

    # Root location handler
    location / {
        # Attempt to connect to the application
        proxy_pass http://app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $fixed_proto;
        
        # Critical: prevent redirect loops
        proxy_redirect off;
        
        # Support for websockets (for real-time chat)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Extended timeouts for AI processing
        proxy_connect_timeout 120s;
        proxy_read_timeout 300s;
        proxy_send_timeout 120s;

        # Add error handling for app connection failures
        error_page 502 503 504 = @app_down;
        
        # Special treatment for health endpoint
        location = /health {
            proxy_pass http://app/health;
            proxy_intercept_errors on;
            error_page 502 503 504 = @fallback_health;
        }
        
        # Emergency contacts endpoint (always available)
        location = /emergency-contacts {
            proxy_pass http://app/emergency-contacts;
            proxy_intercept_errors on;
            error_page 502 503 504 = @emergency_fallback;
        }
    }

    # Fallback for health checks when the app is down
    location @fallback_health {
        return 503 '{"status":"unhealthy","error":"Ask Druk is starting up","service":"Ask Druk - Bhutan AI"}';
        add_header Content-Type application/json;
    }
    
    # Emergency contacts fallback
    location @emergency_fallback {
        return 200 '{
            "emergency_contacts": [
                {"service": "Police", "number": "113", "available": "24/7"},
                {"service": "Fire Department", "number": "110", "available": "24/7"},
                {"service": "Medical Emergency", "number": "112", "available": "24/7"},
                {"service": "Traffic Emergency", "number": "111", "available": "24/7"},
                {"service": "Disaster Helpline", "number": "999", "available": "24/7"}
            ]
        }';
        add_header Content-Type application/json;
    }

    # Fallback when the app is down
    location @app_down {
        return 503 '<!DOCTYPE html>
<html>
<head>
    <title>Ask Druk - Starting Up</title>
    <meta charset="UTF-8">
    <style>
        body { 
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6; padding: 40px; max-width: 800px; margin: 0 auto;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; min-height: 100vh; display: flex; flex-direction: column; justify-content: center;
        }
        .container { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 15px; backdrop-filter: blur(10px); }
        h1 { color: #FFD700; margin-bottom: 20px; }
        .flag { font-size: 48px; margin: 20px 0; }
        .emergency { background: rgba(255,0,0,0.1); padding: 15px; border-radius: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="flag">ðŸ‡§ðŸ‡¹</div>
        <h1>Kuzuzangpo! Ask Druk is Starting Up</h1>
        <p>Ask Druk - Bhutans AI Citizen Assistant is currently initializing. Please wait a moment and try again.</p>
        
        <div class="emergency">
            <h3>ðŸš¨ Emergency Contacts (Always Available)</h3>
            <p><strong>Police:</strong> 113 | <strong>Fire:</strong> 110 | <strong>Medical:</strong> 112</p>
            <p><strong>Traffic:</strong> 111 | <strong>Disaster:</strong> 999</p>
        </div>
        
        <p>If this problem persists, please contact technical support.</p>
        <hr style="border-color: rgba(255,255,255,0.3);">
        <p><small>Ask Druk - Serving Bhutanese Citizens with AI-powered Government Services</small></p>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }

    # Static files with caching
    location /static {
        proxy_pass http://app/static;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $fixed_proto;
        proxy_redirect off;
        
        # Caching for static assets
        proxy_cache_valid 200 302 60m;
        proxy_cache_valid 404 1m;
        expires 7d;
        
        # Fallback for static files if app is down
        error_page 502 503 504 = @static_fallback;
    }
    
    # Fallback for static files
    location @static_fallback {
        try_files /var/app/current/static$uri =404;
    }
}
