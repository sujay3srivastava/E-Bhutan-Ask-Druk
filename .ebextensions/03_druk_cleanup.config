option_settings:
  aws:elasticbeanstalk:container:python:
    WSGIPath: wsgi:application
  aws:elasticbeanstalk:application:environment:
    PYTHONPATH: "/var/app/current"

files:
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/01_cleanup_configs.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      echo "Cleaning up old nginx configurations..."
      
      # Remove any conflicting nginx configs
      rm -f /etc/nginx/conf.d/druk_proxy.conf
      rm -f /etc/nginx/conf.d/session_routing.conf
      rm -f /etc/nginx/conf.d/session_based_proxy.conf
      rm -f /etc/nginx/conf.d/fastapi_proxy.conf
      
      # Remove default configs that might conflict
      if [ -f /etc/nginx/sites-enabled/default ]; then
          rm -f /etc/nginx/sites-enabled/default
      fi
      
      echo "Config cleanup completed"

  "/opt/elasticbeanstalk/hooks/appdeploy/post/05_final_health_check.sh":
    mode: "000755"
    owner: root
    group: root
    content: |
      #!/bin/bash
      echo "=== FINAL HEALTH CHECK ==="
      
      # Wait for application to fully start
      echo "Waiting 30 seconds for application to start..."
      sleep 30
      
      # Check processes
      echo "Checking processes..."
      ps aux | grep -E "(gunicorn|uvicorn|python)" | grep -v grep
      
      # Check listening ports
      echo "Checking listening ports..."
      netstat -tlnp | grep -E ":80|:8000"
      
      # Test application directly
      echo "Testing application on port 8000..."
      if curl -s --connect-timeout 10 http://127.0.0.1:8000/health; then
          echo "✅ Application responds on port 8000"
      else
          echo "❌ Application not responding on port 8000"
          echo "Checking logs..."
          tail -50 /var/log/eb-engine.log
      fi
      
      # Test nginx proxy
      echo "Testing nginx proxy..."
      if curl -s --connect-timeout 10 http://127.0.0.1:80/health; then
          echo "✅ Nginx proxy working"
      else
          echo "❌ Nginx proxy not working"
          nginx -t
          systemctl status nginx
      fi
      
      echo "=== HEALTH CHECK COMPLETE ==="

commands:
  01_update_pip:
    command: "python -m pip install --upgrade pip"
    ignoreErrors: true
